import sys
import os

sys.path.insert(0, os.path.join(os.path.dirname(__file__), "../../.."))

import pytest
from unittest.mock import patch, MagicMock, AsyncMock
from fastapi.testclient import TestClient
from fastapi import status, Request


class TestRoutes:
    @pytest.fixture
    def mock_build_use_case(self):
        """Mock build memory use case"""
        use_case = MagicMock()
        use_case.execute = AsyncMock(return_value={"id": "mem123"})
        return use_case

    @pytest.fixture
    def mock_retrieval_use_case(self):
        """Mock retrieval memory use case"""
        use_case = MagicMock()
        use_case.execute = AsyncMock(return_value={"results": []})
        return use_case

    @pytest.fixture
    def mock_manage_use_case(self):
        """Mock manage memory use case"""
        use_case = MagicMock()
        use_case.get_memory = AsyncMock(return_value=None)
        use_case.get_all_memories = AsyncMock(return_value={"results": [], "total": 0})
        use_case.update_memory = AsyncMock(return_value=None)
        use_case.delete_memory = AsyncMock(return_value=False)
        use_case.get_memory_history = AsyncMock(return_value=[])
        return use_case

    def test_convert_to_memory_response(self):
        """Test converting mem0 data to memory response format"""
        from src.interfaces.api.routes import _convert_to_memory_response

        memory_data = {
            "id": "mem123",
            "memory": "Test memory",
            "hash": "abc123",
            "metadata": {"key": "value"},
            "score": 0.9,
            "rerank_score": 0.95,
            "created_at": "2024-01-01T00:00:00Z",
            "updated_at": "2024-01-02T00:00:00Z",
            "user_id": "user123",
            "agent_id": "agent456",
            "run_id": "run789",
        }

        result = _convert_to_memory_response(memory_data)

        assert result["id"] == "mem123"
        assert result["memory"] == "Test memory"
        assert result["hash"] == "abc123"
        assert result["metadata"] == {"key": "value"}
        assert result["score"] == 0.9
        assert result["rerank_score"] == 0.95
        assert result["created_at"] == "2024-01-01T00:00:00Z"
        assert result["updated_at"] == "2024-01-02T00:00:00Z"
        assert result["user_id"] == "user123"
        assert result["agent_id"] == "agent456"
        assert result["run_id"] == "run789"

    def test_convert_to_memory_response_minimal(self):
        """Test converting minimal mem0 data"""
        from src.interfaces.api.routes import _convert_to_memory_response

        memory_data = {
            "id": "mem123",
            "memory": "Test memory",
            "created_at": "2024-01-01T00:00:00Z",
        }

        result = _convert_to_memory_response(memory_data)

        assert result["id"] == "mem123"
        assert result["memory"] == "Test memory"
        assert result["hash"] is None
        assert result["metadata"] is None
        assert result["score"] is None
        assert result["rerank_score"] == 0

    def test_convert_to_memory_response_with_empty_optional_fields(self):
        """Test converting mem0 data with empty optional fields"""
        from src.interfaces.api.routes import _convert_to_memory_response

        memory_data = {
            "id": "mem123",
            "memory": "Test memory",
            "created_at": "2024-01-01T00:00:00Z",
            "score": None,
            "rerank_score": None,
            "user_id": None,
        }

        result = _convert_to_memory_response(memory_data)

        assert result["score"] in [None, 0]
        assert result["rerank_score"] in [None, 0]
        assert result["user_id"] is None

    @pytest.mark.asyncio
    async def test_build_memory_route_success(self, mock_build_use_case):
        """Test build memory route success"""
        from src.interfaces.api.schemas import BuildMemoryRequest, Message

        with patch(
            "src.interfaces.api.routes.build_memory_use_case", mock_build_use_case
        ):
            from fastapi.testclient import TestClient
            from src.main import app

            client = TestClient(app)
            request = BuildMemoryRequest(
                messages=[Message(role="user", content="Hello")], user_id="user123"
            )

            response = client.post(
                "/api/agent-memory/internal/v1/memory",
                json=request.model_dump(),
                headers={"x-account-id": "user123", "x-account-type": "realname"},
            )

            assert response.status_code == 204

    @pytest.mark.asyncio
    async def test_search_memory_route_success(self, mock_retrieval_use_case):
        """Test search memory route success"""
        from src.interfaces.api.schemas import RetrievalMemoryRequest

        with patch(
            "src.interfaces.api.routes.retrieval_memory_use_case",
            mock_retrieval_use_case,
        ):
            from fastapi.testclient import TestClient
            from src.main import app

            client = TestClient(app)
            request = RetrievalMemoryRequest(
                query="What is AI?", user_id="user123", limit=5
            )

            response = client.post(
                "/api/agent-memory/v1/search", json=request.model_dump()
            )

            assert response.status_code == 200
            data = response.json()
            assert "result" in data
            assert isinstance(data["result"], list)

    @pytest.mark.asyncio
    async def test_get_memory_route_not_found(self, mock_manage_use_case):
        """Test get memory route when memory not found"""
        mock_manage_use_case.get_memory = AsyncMock(return_value=None)

        with patch(
            "src.interfaces.api.routes.manage_memory_use_case", mock_manage_use_case
        ):
            from fastapi.testclient import TestClient
            from src.main import app

            client = TestClient(app)
            response = client.get("/api/agent-memory/v1/memory/nonexistent")

            assert response.status_code == 404

    @pytest.mark.asyncio
    async def test_get_memory_route_success(self, mock_manage_use_case):
        """Test get memory route success"""
        mock_manage_use_case.get_memory = AsyncMock(
            return_value={
                "id": "mem123",
                "memory": "Test",
                "created_at": "2024-01-01T00:00:00Z",
            }
        )

        with patch(
            "src.interfaces.api.routes.manage_memory_use_case", mock_manage_use_case
        ):
            from fastapi.testclient import TestClient
            from src.main import app

            client = TestClient(app)
            response = client.get("/api/agent-memory/v1/memory/mem123")

            assert response.status_code == 200
            data = response.json()
            assert data["id"] == "mem123"

    @pytest.mark.asyncio
    async def test_get_all_memories_route_success(self, mock_manage_use_case):
        """Test get all memories route success"""
        mock_manage_use_case.get_all_memories = AsyncMock(
            return_value={
                "result": [
                    {"id": "mem1", "memory": "Memory 1"},
                    {"id": "mem2", "memory": "Memory 2"},
                ],
                "total": 2,
            }
        )

        with patch(
            "src.interfaces.api.routes.manage_memory_use_case", mock_manage_use_case
        ):
            from fastapi.testclient import TestClient
            from src.main import app

            client = TestClient(app)
            response = client.get("/api/agent-memory/v1/memory?user_id=user123")

            assert response.status_code == 200
            data = response.json()
            assert data["total"] == 2
            assert "result" in data

    @pytest.mark.asyncio
    async def test_update_memory_route_success(self, mock_manage_use_case):
        """Test update memory route success"""
        mock_manage_use_case.get_memory = AsyncMock(return_value={"id": "mem123"})
        mock_manage_use_case.update_memory = AsyncMock(
            return_value={"id": "mem123", "memory": "Updated"}
        )

        with patch(
            "src.interfaces.api.routes.manage_memory_use_case", mock_manage_use_case
        ):
            from fastapi.testclient import TestClient
            from src.main import app

            client = TestClient(app)
            response = client.put(
                "/api/agent-memory/v1/memory/mem123", json={"data": "Updated content"}
            )

            assert response.status_code == 204

    @pytest.mark.asyncio
    async def test_update_memory_route_not_found(self, mock_manage_use_case):
        """Test update memory route when memory not found"""
        mock_manage_use_case.get_memory = AsyncMock(return_value=None)

        with patch(
            "src.interfaces.api.routes.manage_memory_use_case", mock_manage_use_case
        ):
            from fastapi.testclient import TestClient
            from src.main import app

            client = TestClient(app)
            response = client.put(
                "/api/agent-memory/v1/memory/nonexistent",
                json={"data": "Updated content"},
            )

            assert response.status_code == 404

    @pytest.mark.asyncio
    async def test_delete_memory_route_success(self, mock_manage_use_case):
        """Test delete memory route success"""
        mock_manage_use_case.get_memory = AsyncMock(return_value={"id": "mem123"})
        mock_manage_use_case.delete_memory = AsyncMock(return_value=True)

        with patch(
            "src.interfaces.api.routes.manage_memory_use_case", mock_manage_use_case
        ):
            from fastapi.testclient import TestClient
            from src.main import app

            client = TestClient(app)
            response = client.delete("/api/agent-memory/v1/memory/mem123")

            assert response.status_code == 204

    @pytest.mark.asyncio
    async def test_get_memory_history_route_success(self, mock_manage_use_case):
        """Test get memory history route success"""
        mock_manage_use_case.get_memory_history = AsyncMock(
            return_value=[
                {"action": "create", "timestamp": "2024-01-01T00:00:00Z"},
                {"action": "update", "timestamp": "2024-01-02T00:00:00Z"},
            ]
        )

        with patch(
            "src.interfaces.api.routes.manage_memory_use_case", mock_manage_use_case
        ):
            from fastapi.testclient import TestClient
            from src.main import app

            client = TestClient(app)
            response = client.get("/api/agent-memory/v1/memory/mem123/history")

            assert response.status_code == 200
            data = response.json()
            assert "history" in data
            assert len(data["history"]) == 2

    def test_router_prefixes(self):
        """Test router prefixes are correct"""
        from src.interfaces.api.routes import internal_router, external_router

        assert internal_router.prefix == "/api/agent-memory/internal/v1"
        assert external_router.prefix == "/api/agent-memory/v1"

    def test_router_tags(self):
        """Test router tags are correct"""
        from src.interfaces.api.routes import internal_router, external_router

        assert internal_router.tags == ["memory"]
        assert external_router.tags == ["memory"]
